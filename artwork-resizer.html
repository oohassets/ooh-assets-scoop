<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Batch Converter</title>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f1f4f9;
    padding:30px;
}
.container{
    max-width:1200px;
    margin:auto;
}
h2{
    text-align:center;
    margin-bottom:20px;
}
.controls{
    background:#fff;
    padding:20px;
    margin-bottom:20px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:15px;
    border:1px solid #ddd;
}
table{
    width:100%;
    border-collapse:collapse;
    background:#fff;
}
th, td{
    border:1px solid #ddd;
    padding:8px;
    font-size:13px;
    text-align:center;
}
th{
    background:#1565c0;
    color:#fff;
}
button{
    padding:10px 20px;
    margin-top:15px;
    cursor:pointer;
}
button:disabled{
    background:#ccc;
    cursor:not-allowed;
}
.status-loaded{color:#555;}
.status-processing{color:orange;}
.status-done{color:green;}
.progress-bar{
    height:8px;
    background:#ddd;
}
.progress-fill{
    height:8px;
    width:0%;
    background:#1565c0;
}
</style>
</head>
<body>

<div class="container">

<h2>Professional Batch Video Converter</h2>

<div class="controls">
<div>
<label>Width</label>
<input type="number" id="width" value="3670">
</div>

<div>
<label>Height</label>
<input type="number" id="height" value="247">
</div>

<div>
<label>Select Videos</label>
<input type="file" id="fileInput" accept="video/*" multiple>
</div>
</div>

<button id="startBtn" disabled>Start Conversion</button>
<button id="downloadBtn" disabled>Download All</button>

<br><br>

<table>
<thead>
<tr>
<th>Name</th>
<th>Resolution</th>
<th>Duration</th>
<th>Orig MB</th>
<th>New MB</th>
<th>Status</th>
</tr>
</thead>
<tbody id="resultBody"></tbody>
</table>

</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: false });

const fileInput = document.getElementById("fileInput");
const startBtn = document.getElementById("startBtn");
const downloadBtn = document.getElementById("downloadBtn");
const resultBody = document.getElementById("resultBody");

let loadedFiles = [];
let convertedFiles = [];

fileInput.addEventListener("change", async (e)=>{

    loadedFiles = Array.from(e.target.files);
    convertedFiles = [];
    resultBody.innerHTML="";
    downloadBtn.disabled=true;

    if(!loadedFiles.length) return;

    for(let file of loadedFiles){
        if(!file.type.startsWith("video/")) continue;

        const videoURL=URL.createObjectURL(file);
        const video=document.createElement("video");
        video.src=videoURL;
        await new Promise(res=>video.onloadedmetadata=res);

        const row=document.createElement("tr");
        row.innerHTML=`
        <td>${file.name}</td>
        <td>${video.videoWidth}x${video.videoHeight}</td>
        <td>${video.duration.toFixed(2)}s</td>
        <td>${(file.size/1024/1024).toFixed(2)}</td>
        <td>-</td>
        <td class="status-loaded">Loaded</td>
        `;
        resultBody.appendChild(row);
    }

    startBtn.disabled=false;
});

startBtn.addEventListener("click", async ()=>{

    startBtn.disabled=true;
    downloadBtn.disabled=true;

    if(!ffmpeg.isLoaded()){
        await ffmpeg.load();
    }

    const width=document.getElementById("width").value;
    const height=document.getElementById("height").value;

    const rows=resultBody.querySelectorAll("tr");

    for(let i=0;i<loadedFiles.length;i++){

        const file=loadedFiles[i];
        const row=rows[i];

        row.cells[5].innerHTML=`<span class="status-processing">Processing...</span>`;

        const inputName=file.name;
        const outputName=`${width}x${height}_30fps_HQ_${file.name}`;

        ffmpeg.FS("writeFile",inputName,await fetchFile(file));

        ffmpeg.setProgress(({ratio})=>{
            row.cells[5].innerHTML=
            `<div class="progress-bar">
               <div class="progress-fill" style="width:${Math.round(ratio*100)}%"></div>
             </div>`;
        });

        await ffmpeg.run(
            "-i", inputName,
            "-vf", `scale=${width}:${height}:force_original_aspect_ratio=decrease,pad=${width}:${height}:(ow-iw)/2:(oh-ih)/2:black`,
            "-r", "30",
            "-c:v", "libx264",
            "-preset", "slow",
            "-profile:v", "high",
            "-pix_fmt", "yuv420p",
            "-movflags", "+faststart",
            "-crf", "18",
            "-c:a", "aac",
            "-b:a", "192k",
            outputName
        );

        const data=ffmpeg.FS("readFile",outputName);

        convertedFiles.push({
            name:outputName,
            data:data
        });

        row.cells[4].innerText=(data.length/1024/1024).toFixed(2);
        row.cells[5].innerHTML=`<span class="status-done">Done</span>`;
    }

    if(convertedFiles.length>0){
        downloadBtn.disabled=false;
    }

});

downloadBtn.addEventListener("click", async ()=>{

    const zip=new JSZip();
    convertedFiles.forEach(file=>{
        zip.file(file.name,file.data);
    });

    const content=await zip.generateAsync({type:"blob"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(content);
    link.download="converted_30fps_HQ_batch.zip";
    link.click();
});
</script>

</body>
</html>